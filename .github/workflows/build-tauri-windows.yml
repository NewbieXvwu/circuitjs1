name: Build Tauri Windows x64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Build GWT project
        run: |
          ./gradlew compileGwt --console verbose --info
          ./gradlew makeSite --console verbose --info
        shell: pwsh
      
      - name: Verify site directory
        run: |
          Write-Host "Checking site directory..."
          if (-Not (Test-Path "site")) {
            Write-Host "ERROR: site directory does not exist!"
            exit 1
          }
          Write-Host "site directory exists, listing contents..."
          Get-ChildItem -Path site -Recurse | Select-Object -First 20
        shell: pwsh
      
      - name: Prepare Tauri build
        run: |
          Write-Host "Preparing Tauri build..."
          
          # Copy site to site-tauri
          if (Test-Path "site-tauri") {
            Remove-Item -Recurse -Force site-tauri
          }
          Copy-Item -Path site -Destination site-tauri -Recurse
          Write-Host "Copied site to site-tauri"
          
          # Inject Tauri API into circuitjs.html
          Write-Host "Injecting Tauri API script..."
          $htmlPath = "site-tauri/circuitjs.html"
          $htmlContent = Get-Content $htmlPath -Raw -Encoding UTF8
          
          # Create the Tauri API injection script
          $tauriScript = @'
<script type="text/javascript" src="https://unpkg.com/@tauri-apps/api@1.6.0/dist/tauri.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      if (window.__TAURI__) {
        (function() {
          const { invoke } = window.__TAURI__.tauri;
          let lastSavedFilePath = null;
          window.showSaveDialog = async function() {
            try {
              const result = await invoke("show_save_dialog");
              return result ? { filePath: result } : undefined;
            } catch (error) {
              console.error("Error showing save dialog:", error);
              return undefined;
            }
          };
          window.saveFile = async function(file, text) {
            try {
              let path;
              if (!file) {
                path = lastSavedFilePath;
              } else {
                path = file.filePath || file;
                lastSavedFilePath = path;
              }
              if (!path) {
                window.alert("No file path specified");
                return;
              }
              await invoke("save_file", { path, content: text });
            } catch (error) {
              window.alert("Error saving file: " + error);
            }
          };
          window.openFile = async function(callback) {
            try {
              const result = await invoke("open_file_dialog");
              if (result) {
                lastSavedFilePath = result.file_path;
                callback(result.content, result.file_name);
              }
            } catch (error) {
              window.alert("Error opening file: " + error);
            }
          };
          window.toggleDevTools = async function() {
            try {
              await invoke("toggle_dev_tools");
            } catch (error) {
              console.error("Error toggling dev tools:", error);
            }
          };
          console.log("Tauri API loaded");
        })();
      }
    </script>
'@
          
          # Insert before lz-string.min.js script
          $htmlContent = $htmlContent -replace '(<script language="javascript" src="lz-string\.min\.js"></script>)', "$tauriScript`n    `$1"
          
          # Save the modified HTML
          $htmlContent | Out-File -FilePath $htmlPath -Encoding UTF8 -NoNewline
          
          Write-Host "Tauri API injected successfully"
        shell: pwsh
      
      - name: Verify site-tauri directory
        run: |
          Write-Host "Checking site-tauri directory..."
          if (-Not (Test-Path "site-tauri")) {
            Write-Host "ERROR: site-tauri directory does not exist!"
            exit 1
          }
          Write-Host "site-tauri directory exists, listing contents..."
          Get-ChildItem -Path site-tauri -Recurse | Select-Object -First 20
        shell: pwsh
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Cache Tauri CLI
        id: cache-tauri-cli
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-tauri*
          key: ${{ runner.os }}-tauri-cli-1.5.11
      
      - name: Install Tauri CLI
        if: steps.cache-tauri-cli.outputs.cache-hit != 'true'
        run: |
          Write-Host "Installing Tauri CLI..."
          cargo install tauri-cli --version "^1.5.0" --locked
        shell: pwsh
      
      - name: Verify Tauri CLI
        run: |
          Write-Host "Tauri CLI version:"
          cargo tauri --version
        shell: pwsh
      
      - name: Generate icons for Windows
        run: |
          Write-Host "=== Generating Windows icons ==="
          
          # Install required tools
          Write-Host "Installing ImageMagick..."
          choco install imagemagick -y
          
          # Refresh environment to get magick command
          $env:PATH = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Generate icon.ico from icon.png
          Write-Host "Generating icon.ico..."
          magick convert src-tauri/icons/icon.png -define icon:auto-resize=256,128,64,48,32,16 src-tauri/icons/icon.ico
          
          # Generate icon.icns for macOS (even though we're building for Windows, it's needed)
          Write-Host "Generating icon.icns..."
          $sizes = @(16, 32, 64, 128, 256, 512)
          $iconsetDir = "src-tauri/icons/icon.iconset"
          New-Item -ItemType Directory -Force -Path $iconsetDir | Out-Null
          
          foreach ($size in $sizes) {
            magick convert src-tauri/icons/icon.png -resize "${size}x${size}" "$iconsetDir/icon_${size}x${size}.png"
            if ($size -le 256) {
              $size2x = $size * 2
              magick convert src-tauri/icons/icon.png -resize "${size2x}x${size2x}" "$iconsetDir/icon_${size}x${size}@2x.png"
            }
          }
          
          # Note: icns creation requires iconutil which is macOS-only, so we'll create a placeholder
          # The build will use icon.ico on Windows
          Write-Host "Creating placeholder icon.icns..."
          Copy-Item src-tauri/icons/icon.png src-tauri/icons/icon.icns
          
          Write-Host "=== Icon generation complete ==="
        shell: pwsh
      
      - name: Build Tauri app
        run: |
          Write-Host "=== Building Tauri application ==="
          Write-Host "Current directory: $(Get-Location)"
          Write-Host ""
          
          # Build the Tauri app
          cargo tauri build --target x86_64-pc-windows-msvc
          
          Write-Host ""
          Write-Host "=== Build completed successfully ==="
          Write-Host "Checking target directory..."
          if (Test-Path "src-tauri/target/x86_64-pc-windows-msvc/release/bundle") {
            Get-ChildItem src-tauri/target/x86_64-pc-windows-msvc/release/bundle -Recurse | 
              Where-Object { $_.Extension -in @('.exe', '.msi') } | 
              ForEach-Object { Write-Host "  - $($_.FullName)" }
          }
        shell: pwsh
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CircuitJS1-Tauri-Windows-x64
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          if-no-files-found: error
